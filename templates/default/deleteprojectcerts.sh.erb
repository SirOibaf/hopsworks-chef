#!/bin/bash

# Copyright (C) 2014 - 2018 Logical Clocks AB. All rights reserved.
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

if [ $# -ne 1  ]; then
 echo "incorrect usage"
 exit 1
fi

DOMAIN="$1"

KEYSTOREPW=<%= node['hopsworks']['admin']['password'] %>
cd <%= @int_ca_dir %>

# First revoke the certificate
function revoke {
    openssl ca -batch -config openssl-intermediate.cnf \
	    -passin pass:$KEYSTOREPW \
	    -revoke certs/$1.cert.pem
}

# Then delete them from the file system
function delete {
    rm -f <%= @int_ca_dir %>/private/$1.key.pem
    rm -f <%= @int_ca_dir %>/certs/$1.cert.pem
    rm -f <%= @int_ca_dir %>/csr/$1.csr.pem
}

# Revoke and delete the certificates for the project specific users
revoke "${DOMAIN}__*"
delete "${DOMAIN}__*"

# Revoke and delete the generic project certificate
revoke ${DOMAIN}
delete ${DOMAIN}
