#!/bin/bash

# Copyright (C) 2014 - 2018 Logical Clocks AB. All rights reserved.
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

if [ $# -ne 5  ]; then
    echo "Usage: $0 ca_file masterpassword extension csr_path generated_cert_path"
    echo "Example: $0 /srv/hops/certs-dir/openssl-ca.cnf adminpw v3_intermediate_ca /tmp/123.csr /tmp/123.pem"
 exit 1
fi

set -e

#Variables
CA_FILE="$1"
MASTERPW="$2"
EXTENSION="$3"
CSR_PATH="$4"
GENERATED_CERT_PATH="$5"

openssl ca -batch -config $CA_FILE -passin pass:${MASTERPW} \
        -extensions $EXTENSION -days 3650 -notext -md sha256 -in ${CSR_PATH} -out ${GENERATED_CERT_PATH}


chmod +r ${GENERATED_CERT_PATH}
